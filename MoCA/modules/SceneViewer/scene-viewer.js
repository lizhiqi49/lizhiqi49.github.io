export class ViewerModule{constructor(e,t,o,i){this.container=e,this.modelBaseNames=t,this.modelPath=o,this.imagePath=i,this.imageExtension=".png",this.modelExtension=".glb",this.originalScene=null,this.explodedScene=null,this.originalCamera=null,this.explodedCamera=null,this.originalRenderer=null,this.explodedRenderer=null,this.originalModel=null,this.explodedModel=null,this.originalControls=null,this.explodedControls=null,this.explodeAmount=0,this.autoRotate=!0,this.rotationSpeed=.01,this.rotationAngle=0}init(){this.setupScene(),this.createImageSlider(),this.loadModel(this.modelBaseNames[0])}setupScene(){const e=document.querySelector(`${this.container} #viewer-container`),t=e.clientWidth,o=e.clientHeight,i=t/2;this.originalScene=new THREE.Scene,this.originalCamera=new THREE.PerspectiveCamera(35,i/o,.01,100),this.originalCamera.position.set(0,0,2),this.originalRenderer=new THREE.WebGLRenderer({antialias:!0}),this.originalRenderer.setSize(i,o),this.originalRenderer.setClearColor(16777215),this.originalRenderer.outputEncoding=THREE.sRGBEncoding,this.originalRenderer.physicallyCorrectLights=!0,this.originalRenderer.domElement.style.position="absolute",this.originalRenderer.domElement.style.left="0",this.originalRenderer.domElement.style.top="0",e.appendChild(this.originalRenderer.domElement),this.originalControls=new THREE.OrbitControls(this.originalCamera,this.originalRenderer.domElement),this.originalControls.enableDamping=!0,this.originalControls.dampingFactor=.25,this.originalControls.autoRotate=!1,this.explodedScene=new THREE.Scene,this.explodedCamera=new THREE.PerspectiveCamera(35,i/o,.01,100),this.explodedCamera.position.set(0,0,2),this.explodedRenderer=new THREE.WebGLRenderer({antialias:!0}),this.explodedRenderer.setSize(i,o),this.explodedRenderer.setClearColor(16777215),this.explodedRenderer.outputEncoding=THREE.sRGBEncoding,this.explodedRenderer.physicallyCorrectLights=!0,this.explodedRenderer.domElement.style.position="absolute",this.explodedRenderer.domElement.style.right="0",this.explodedRenderer.domElement.style.top="0",e.appendChild(this.explodedRenderer.domElement),this.explodedControls=new THREE.OrbitControls(this.explodedCamera,this.explodedRenderer.domElement),this.explodedControls.enableDamping=!0,this.explodedControls.dampingFactor=.25,this.explodedControls.autoRotate=!1,this.setupLighting(this.originalScene),this.setupLighting(this.explodedScene),window.addEventListener("resize",(()=>{const t=e.clientWidth,o=e.clientHeight,i=t/2;this.originalRenderer.setSize(i,o),this.originalCamera.aspect=i/o,this.originalCamera.updateProjectionMatrix(),this.explodedRenderer.setSize(i,o),this.explodedCamera.aspect=i/o,this.explodedCamera.updateProjectionMatrix()})),this.animate()}setupLighting(e){const t=new THREE.AmbientLight(16777215,.6);e.add(t);const o=new THREE.DirectionalLight(16777215,1.5);o.position.set(8,12,8),o.target.position.set(0,0,0),e.add(o),e.add(o.target);const i=new THREE.DirectionalLight(16777215,.8);i.position.set(-6,8,-6),i.target.position.set(0,0,0),e.add(i),e.add(i.target);const n=new THREE.DirectionalLight(16777215,.5);n.position.set(0,0,-10),n.target.position.set(0,0,0),e.add(n),e.add(n.target);const s=new THREE.HemisphereLight(8900331,9139029,.5);e.add(s)}loadModel(e,t){this.originalModel&&this.originalScene.remove(this.originalModel),this.explodedModel&&this.explodedScene.remove(this.explodedModel);const o=document.querySelector(`${this.container} #loading-overlay`);o.style.display="flex";(new THREE.GLTFLoader).load(`${this.modelPath}/${e}${this.modelExtension}`,(t=>{this.originalModel=t.scene.clone(),this.explodedModel=t.scene.clone(),this.originalModel.userData.baseName=e,this.explodedModel.userData.baseName=e,this.originalScene.add(this.originalModel),this.explodedScene.add(this.explodedModel),[this.originalModel,this.explodedModel].forEach((e=>{e.traverse((e=>{e.isMesh&&(e.visible=!0,e.material&&(e.material.color.set(16316664),e.material.metalness=0,e.material.roughness=.5,e.material.normalScale=new THREE.Vector2(1,1),e.material.envMapIntensity=.2,e.material.needsUpdate=!0))}))})),this.storeOriginalPositions(this.explodedModel),this.fitModelToView(this.originalModel,.8),this.fitModelToView(this.explodedModel,.6),this.explodeAmount=.3,this.applyExplodeEffect(this.explodeAmount),this.positionCameras(),this.createExplodeControls(),o.style.display="none"}))}changeModelColor(e){[this.originalModel,this.explodedModel].forEach((t=>{t&&t.traverse((t=>{t.isMesh&&t.material&&(t.material.color.set(e),t.material.needsUpdate=!0)}))}))}storeOriginalPositions(e){if(!e)return;const t=e.children[0];t&&t.children.forEach((e=>{e.userData.originalPosition=e.position.clone()}))}fitModelToView(e,t=1){if(!e)return;const o=(new THREE.Box3).setFromObject(e),i=o.getSize(new THREE.Vector3),n=o.getCenter(new THREE.Vector3),s=1.5/Math.max(i.x,i.y,i.z)*t;e.scale.setScalar(s),e.position.sub(n.multiplyScalar(s))}positionCameras(){const e=2.5;this.originalCamera.position.set(0,0,e),this.originalCamera.lookAt(0,0,0),this.explodedCamera.position.set(0,0,e),this.explodedCamera.lookAt(0,0,0)}createImageSlider(){const e=document.querySelector(`${this.container} #image-slider`);this.modelBaseNames.forEach(((t,o)=>{const i=document.createElement("div");i.classList.add("swiper-slide");const n=document.createElement("img");n.src=`${this.imagePath}/${t}${this.imageExtension}`,n.alt=`Model ${o+1}`,n.onclick=()=>this.loadModel(t,o),i.appendChild(n),e.appendChild(i)})),this.swiper=new Swiper(`${this.container} .swiper`,{slidesPerView:"auto",slidesPerGroup:2,spaceBetween:10,rewind:!0,navigation:{nextEl:`${this.container} .swiper-button-next`,prevEl:`${this.container} .swiper-button-prev`}})}createExplodeControls(){const e=document.querySelector(`${this.container} #button-block`);e.innerHTML="";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.gap="20px",t.style.margin="10px";const o=document.createElement("button");o.textContent=this.autoRotate?"Stop Rotate":"Auto Rotate",o.style.padding="10px 20px",o.style.fontSize="16px",o.style.fontWeight="bold",o.style.backgroundColor=this.autoRotate?"#28a745":"#6c757d",o.style.color="white",o.style.border="none",o.style.borderRadius="5px",o.style.cursor="pointer",o.style.transition="background-color 0.3s",o.style.width="140px",o.style.minWidth="140px",o.style.height="40px",o.style.textAlign="center",o.onmouseover=()=>{o.style.backgroundColor=this.autoRotate?"#218838":"#5a6268"},o.onmouseout=()=>{o.style.backgroundColor=this.autoRotate?"#28a745":"#6c757d"},o.onclick=()=>{this.autoRotate=!this.autoRotate,o.textContent=this.autoRotate?"Stop Rotate":"Auto Rotate",o.style.backgroundColor=this.autoRotate?"#28a745":"#6c757d"};const i=document.createElement("button");i.textContent=0===this.explodeAmount?"Explode":"Reset",i.style.padding="10px 20px",i.style.fontSize="16px",i.style.fontWeight="bold",i.style.backgroundColor="#007bff",i.style.color="white",i.style.border="none",i.style.borderRadius="5px",i.style.cursor="pointer",i.style.transition="background-color 0.3s",i.style.width="100px",i.style.minWidth="100px",i.style.height="40px",i.style.textAlign="center",i.onmouseover=()=>{i.style.backgroundColor="#0056b3"},i.onmouseout=()=>{i.style.backgroundColor="#007bff"},i.onclick=()=>{0===this.explodeAmount?(this.explodeAmount=.3,i.textContent="Reset",this.applyExplodeEffect(this.explodeAmount)):this.reloadModel(),l.value=this.explodeAmount.toString()};const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.gap="10px";const s=document.createElement("span");s.textContent="Explode: ",s.style.fontWeight="bold",s.style.fontSize="16px";const l=document.createElement("input");l.type="range",l.min="0",l.max="1",l.step="0.01",l.value=this.explodeAmount.toString(),l.style.width="200px",l.oninput=e=>{this.explodeAmount=parseFloat(e.target.value),this.applyExplodeEffect(this.explodeAmount),i.textContent=0===this.explodeAmount?"Explode":"Reset"},n.appendChild(s),n.appendChild(l),t.appendChild(o),t.appendChild(i),t.appendChild(n),e.appendChild(t)}applyExplodeEffect(e){if(!this.explodedModel)return;const t=this.explodedModel.children[0];t&&t.children.forEach((t=>{const o=(new THREE.Box3).setFromObject(t).getCenter(new THREE.Vector3).clone().sub(this.explodedScene.position).normalize(),i=t.userData.originalPosition||t.position.clone(),n=o.multiplyScalar(1*e),s=i.clone().add(n);t.position.copy(s)}))}rotateParts(){if(!this.explodedModel)return;const e=this.explodedModel.children[0];e&&(e.children.forEach((e=>{e.userData.originalRotation||(e.userData.originalRotation=e.rotation.clone()),e.userData.originalPosition||(e.userData.originalPosition=e.position.clone()),e.rotation.y=this.rotationAngle})),this.applyExplodeEffect(this.explodeAmount))}resetPartRotations(){if(!this.explodedModel)return;const e=this.explodedModel.children[0];e&&(e.children.forEach((e=>{e.userData.originalRotation?e.rotation.copy(e.userData.originalRotation):e.rotation.set(0,0,0)})),this.rotationAngle=0)}reloadModel(){const e=this.modelBaseNames.findIndex((e=>this.originalModel&&this.originalModel.userData&&this.originalModel.userData.baseName===e));-1===e?this.loadModel(this.modelBaseNames[0]):this.loadModel(this.modelBaseNames[e])}animate(){requestAnimationFrame((()=>this.animate())),this.autoRotate&&(this.rotationAngle+=this.rotationSpeed,this.rotateParts()),this.originalControls.update(),this.explodedControls.update(),this.originalRenderer.render(this.originalScene,this.originalCamera),this.explodedRenderer.render(this.explodedScene,this.explodedCamera)}}