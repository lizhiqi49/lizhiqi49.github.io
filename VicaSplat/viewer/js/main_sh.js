function getProjectionMatrix(e,t,a,n){const r=.2,i=500;return[[2*e/a,0,0,0],[0,-2*t/n,0,0],[0,0,i/(i-r),1],[0,0,-i*r/(i-r),0]].flat()}function getViewMatrix(e){let t=e.worldToCam;return[t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]]}function multiply4(e,t){return[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]]}function invert4(e){let t=e[0]*e[5]-e[1]*e[4],a=e[0]*e[6]-e[2]*e[4],n=e[0]*e[7]-e[3]*e[4],r=e[1]*e[6]-e[2]*e[5],i=e[1]*e[7]-e[3]*e[5],o=e[2]*e[7]-e[3]*e[6],s=e[8]*e[13]-e[9]*e[12],c=e[8]*e[14]-e[10]*e[12],l=e[8]*e[15]-e[11]*e[12],d=e[9]*e[14]-e[10]*e[13],u=e[9]*e[15]-e[11]*e[13],f=e[10]*e[15]-e[11]*e[14],v=t*f-a*u+n*d+r*l-i*c+o*s;return v?[(e[5]*f-e[6]*u+e[7]*d)/v,(e[2]*u-e[1]*f-e[3]*d)/v,(e[13]*o-e[14]*i+e[15]*r)/v,(e[10]*i-e[9]*o-e[11]*r)/v,(e[6]*l-e[4]*f-e[7]*c)/v,(e[0]*f-e[2]*l+e[3]*c)/v,(e[14]*n-e[12]*o-e[15]*a)/v,(e[8]*o-e[10]*n+e[11]*a)/v,(e[4]*u-e[5]*l+e[7]*s)/v,(e[1]*l-e[0]*u-e[3]*s)/v,(e[12]*i-e[13]*n+e[15]*t)/v,(e[9]*n-e[8]*i-e[11]*t)/v,(e[5]*c-e[4]*d-e[6]*s)/v,(e[0]*d-e[1]*c+e[2]*s)/v,(e[13]*a-e[12]*r-e[14]*t)/v,(e[8]*r-e[9]*a+e[10]*t)/v]:null}function rotate4(e,t,a,n,r){let i=Math.hypot(a,n,r);a/=i,n/=i,r/=i;let o=Math.sin(t),s=Math.cos(t),c=1-s,l=a*a*c+s,d=n*a*c+r*o,u=r*a*c-n*o,f=a*n*c-r*o,v=n*n*c+s,m=r*n*c+a*o,h=a*r*c+n*o,x=n*r*c-a*o,p=r*r*c+s;return[e[0]*l+e[4]*d+e[8]*u,e[1]*l+e[5]*d+e[9]*u,e[2]*l+e[6]*d+e[10]*u,e[3]*l+e[7]*d+e[11]*u,e[0]*f+e[4]*v+e[8]*m,e[1]*f+e[5]*v+e[9]*m,e[2]*f+e[6]*v+e[10]*m,e[3]*f+e[7]*v+e[11]*m,e[0]*h+e[4]*x+e[8]*p,e[1]*h+e[5]*x+e[9]*p,e[2]*h+e[6]*x+e[10]*p,e[3]*h+e[7]*x+e[11]*p,...e.slice(12,16)]}function translate4(e,t,a,n){return[...e.slice(0,12),e[0]*t+e[4]*a+e[8]*n+e[12],e[1]*t+e[5]*a+e[9]*n+e[13],e[2]*t+e[6]*a+e[10]*n+e[14],e[3]*t+e[7]*a+e[11]*n+e[15]]}function createWorker(e){function t(e){m[0]=e;var t,a=h[0],n=a>>23&255,r=8388607&a;return 0==n?t=0:n<113?(t=0,r|=8388608,16777216&(r>>=113-n)&&(t=1,r=0)):n<142?t=n-112:(t=31,r=0),(a>>31&1)<<15|t<<10|r>>13}function a(e,a){return(t(e)|t(a)<<16)>>>0}function n(){if(!o)return;const t=new Float32Array(o),n=new Uint8Array(o);var r=2048,i=Math.ceil(2*c/r),s=new Uint32Array(r*i*d/4/2),u=new Uint8Array(s.buffer),f=new Float32Array(s.buffer),v=d,m=d/4;for(let e=0;e<c;e++){f[m*e+0]=t[m*e+0],f[m*e+1]=t[m*e+1],f[m*e+2]=t[m*e+2],u[4*(m*e+7)+0]=n[v*e+24+0],u[4*(m*e+7)+1]=n[v*e+24+1],u[4*(m*e+7)+2]=n[v*e+24+2],u[4*(m*e+7)+3]=n[v*e+24+3];let r=[t[m*e+3+0],t[m*e+3+1],t[m*e+3+2]],i=[(n[v*e+28+0]-128)/128,(n[v*e+28+1]-128)/128,(n[v*e+28+2]-128)/128,(n[v*e+28+3]-128)/128];const o=[1-2*(i[2]*i[2]+i[3]*i[3]),2*(i[1]*i[2]+i[0]*i[3]),2*(i[1]*i[3]-i[0]*i[2]),2*(i[1]*i[2]-i[0]*i[3]),1-2*(i[1]*i[1]+i[3]*i[3]),2*(i[2]*i[3]+i[0]*i[1]),2*(i[1]*i[3]+i[0]*i[2]),2*(i[2]*i[3]-i[0]*i[1]),1-2*(i[1]*i[1]+i[2]*i[2])].map(((e,t)=>e*r[Math.floor(t/3)])),c=[o[0]*o[0]+o[3]*o[3]+o[6]*o[6],o[0]*o[1]+o[3]*o[4]+o[6]*o[7],o[0]*o[2]+o[3]*o[5]+o[6]*o[8],o[1]*o[1]+o[4]*o[4]+o[7]*o[7],o[1]*o[2]+o[4]*o[5]+o[7]*o[8],o[2]*o[2]+o[5]*o[5]+o[8]*o[8]];s[m*e+4]=a(4*c[0],4*c[1]),s[m*e+5]=a(4*c[2],4*c[3]),s[m*e+6]=a(4*c[4],4*c[5]);for(var h=0;h<(l+1)**2*3;h++)f[m*e+8+h]=t[m*e+8+h]}e.postMessage({texdata:s,texwidth:r,texheight:i},[s.buffer])}function r(t){if(!o)return;const a=new Float32Array(o);if(v==c){let e=u[2]*t[2]+u[6]*t[6]+u[10]*t[10];if(Math.abs(e-1)<.01)return}else n(),v=c;let r=-1/0,i=1/0,s=new Int32Array(c);for(let e=0;e<c;e++){let n=4096*(t[2]*a[8*e+0]+t[6]*a[8*e+1]+t[10]*a[8*e+2])|0;s[e]=n,n>r&&(r=n),n<i&&(i=n)}let l=65536/(r-i),d=new Uint32Array(65536);for(let e=0;e<c;e++)s[e]=(s[e]-i)*l|0,d[s[e]]++;let m=new Uint32Array(65536);for(let e=1;e<65536;e++)m[e]=m[e-1]+d[e-1];f=new Uint32Array(c);for(let e=0;e<c;e++)f[m[s[e]]++]=e;u=t,e.postMessage({depthIndex:f,viewProj:t,vertexCount:c},[f.buffer])}function i(e){const t=new Uint8Array(e),a=(new TextDecoder).decode(t.slice(0,10240)),n="end_header\n",r=a.indexOf(n);if(r<0)throw new Error("Unable to read .ply file header");const i=parseInt(/element vertex (\d+)\n/.exec(a)[1]);let o=0,s={},c={};const l={double:"getFloat64",int:"getInt32",uint:"getUint32",float:"getFloat32",short:"getInt16",ushort:"getUint16",uchar:"getUint8"};for(let e of a.slice(0,r).split("\n").filter((e=>e.startsWith("property ")))){const[t,a,n]=e.split(" "),r=l[a]||"getInt8";c[n]=r,s[n]=o,o+=parseInt(r.replace(/[^\d]/g,""))/8}let d=new DataView(e,r+n.length),u=0;const f=new Proxy({},{get(e,t){if(!c[t])throw new Error(t+" not found");return d[c[t]](u*o+s[t],!0)}});let v=new Float32Array(i),m=new Uint32Array(i);for(u=0;u<i;u++){if(m[u]=u,!c.scale_0)continue;const e=Math.exp(f.scale_0)*Math.exp(f.scale_1)*Math.exp(f.scale_2),t=1/(1+Math.exp(-f.opacity));v[u]=e*t}m.sort(((e,t)=>v[t]-v[e]));const h=3,x=32+(h+1)**2*3*4,p=new ArrayBuffer(x*i);for(let e=0;e<i;e++){u=m[e];const t=new Float32Array(p,e*x,3),a=new Float32Array(p,e*x+12,3),n=new Uint8ClampedArray(p,e*x+12+12,4),r=new Uint8ClampedArray(p,e*x+12+12+4,4),i=new Float32Array(p,e*x+12+12+4+4,(h+1)**2*3);if(c.scale_0){const e=Math.sqrt(f.rot_0**2+f.rot_1**2+f.rot_2**2+f.rot_3**2);r[0]=f.rot_0/e*128+128,r[1]=f.rot_1/e*128+128,r[2]=f.rot_2/e*128+128,r[3]=f.rot_3/e*128+128,a[0]=Math.exp(f.scale_0),a[1]=Math.exp(f.scale_1),a[2]=Math.exp(f.scale_2)}else a[0]=.01,a[1]=.01,a[2]=.01,r[0]=255,r[1]=0,r[2]=0,r[3]=0;if(t[0]=f.x,t[1]=f.y,t[2]=f.z,c.f_dc_0){const e=.28209479177387814;n[0]=255*(.5+e*f.f_dc_0),n[1]=255*(.5+e*f.f_dc_1),n[2]=255*(.5+e*f.f_dc_2),i[0]=f.f_dc_0,i[1]=f.f_dc_1,i[2]=f.f_dc_2}else n[0]=f.red,n[1]=f.green,n[2]=f.blue;if(c.f_rest_0)for(let e=0;e<(h+1)**2*3-3;e++)i[e+3]=f[`f_rest_${e}`];c.opacity?n[3]=1/(1+Math.exp(-f.opacity))*255:n[3]=255}return p}let o,s,c=0;const l=3,d=32+3*((l+1)**2-1)*4;let u=[],f=new Uint32Array,v=0;var m=new Float32Array(1),h=new Int32Array(m.buffer);const x=()=>{if(!p){p=!0;let e=s;r(e),setTimeout((()=>{p=!1,e!==s&&x()}),0)}};let p;e.onmessage=e=>{e.data.ply?(c=0,r(s),o=i(e.data.ply),c=Math.floor(o.byteLength/d),postMessage({buffer:o})):e.data.buffer?(o=e.data.buffer,c=e.data.vertexCount):e.data.vertexCount?c=e.data.vertexCount:e.data.view&&(s=e.data.view,x())}}async function main(){let e=!1;const t=new URLSearchParams(location.search);try{viewMatrix=JSON.parse(decodeURIComponent(location.hash.slice(1))),e=!1}catch(e){}let a=window.location.href,n=t.get("url")||"assets/demo.ply",r="";r=n.startsWith("http")?new URL(n):new URL(t.get("url")||"assets/demo.ply",a),is_object=t.get("is_object")||"true",cameras="true"==is_object?[cameras[0]]:[cameras[1]],camera=cameras[currentCameraIndex],camera.fx=t.get("fx")||camera.fx,camera.fy=t.get("fy")||camera.fy;let i=t.get("w2c");try{i=i?i.split(",").map(parseFloat):camera.worldToCam}catch(e){}defaultViewMatrix=getViewMatrix(camera),viewMatrix=defaultViewMatrix;const o=await fetch(r,{mode:"cors",credentials:"omit"});if(200!=o.status)throw new Error(o.status+" Unable to load "+o.url);const s=27+3*((3+1)**2-1)*4+32+2,c=o.body.getReader();let l=new Uint8Array(o.headers.get("content-length"));const d=1,u=new Worker(URL.createObjectURL(new Blob(["(",createWorker.toString(),")(self)"],{type:"application/javascript"}))),f=document.getElementById("canvas"),v=document.getElementById("fps"),m=document.getElementById("camid");let h;const x=f.getContext("webgl2",{antialias:!1}),p=x.createShader(x.VERTEX_SHADER);x.shaderSource(p,vertexShaderSource),x.compileShader(p),x.getShaderParameter(p,x.COMPILE_STATUS);const w=x.createShader(x.FRAGMENT_SHADER);x.shaderSource(w,fragmentShaderSource),x.compileShader(w),x.getShaderParameter(w,x.COMPILE_STATUS);const g=x.createProgram();x.attachShader(g,p),x.attachShader(g,w),x.linkProgram(g),x.useProgram(g),x.getProgramParameter(g,x.LINK_STATUS),x.disable(x.DEPTH_TEST),x.enable(x.BLEND),x.blendFuncSeparate(x.ONE_MINUS_DST_ALPHA,x.ONE,x.ONE_MINUS_DST_ALPHA,x.ONE),x.blendEquationSeparate(x.FUNC_ADD,x.FUNC_ADD);const y=x.getUniformLocation(g,"projection"),M=x.getUniformLocation(g,"viewport"),_=x.getUniformLocation(g,"focal"),E=x.getUniformLocation(g,"view"),A=new Float32Array([-2,-2,2,-2,2,2,-2,2]),b=x.createBuffer();x.bindBuffer(x.ARRAY_BUFFER,b),x.bufferData(x.ARRAY_BUFFER,A,x.STATIC_DRAW);const T=x.getAttribLocation(g,"position");x.enableVertexAttribArray(T),x.bindBuffer(x.ARRAY_BUFFER,b),x.vertexAttribPointer(T,2,x.FLOAT,!1,0,0);var R=x.createTexture();x.bindTexture(x.TEXTURE_2D,R);var U=x.getUniformLocation(g,"u_texture");x.uniform1i(U,0);const I=x.createBuffer(),L=x.getAttribLocation(g,"index");x.enableVertexAttribArray(L),x.bindBuffer(x.ARRAY_BUFFER,I),x.vertexAttribIPointer(L,1,x.INT,!1,0,0),x.vertexAttribDivisor(L,1);const S=()=>{x.uniform2fv(_,new Float32Array([camera.fx,camera.fy])),h=getProjectionMatrix(camera.fx,camera.fy,innerWidth,innerHeight),x.uniform2fv(M,new Float32Array([innerWidth,innerHeight])),x.canvas.width=Math.round(innerWidth/d),x.canvas.height=Math.round(innerHeight/d),x.viewport(0,0,x.canvas.width,x.canvas.height),x.uniformMatrix4fv(y,!1,h)};window.addEventListener("resize",S),S(),u.onmessage=e=>{if(e.data.buffer);else if(e.data.texdata){const{texdata:t,texwidth:a,texheight:n}=e.data;x.bindTexture(x.TEXTURE_2D,R),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texImage2D(x.TEXTURE_2D,0,x.RGBA32UI,a,n,0,x.RGBA_INTEGER,x.UNSIGNED_INT,t),x.activeTexture(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,R)}else if(e.data.depthIndex){const{depthIndex:t,viewProj:a}=e.data;x.bindBuffer(x.ARRAY_BUFFER,I),x.bufferData(x.ARRAY_BUFFER,t,x.DYNAMIC_DRAW),V=e.data.vertexCount}};let C,D,F,P=[];window.addEventListener("keydown",(t=>{e=!1,P.includes(t.code)||P.push(t.code),/\d/.test(t.key)&&(currentCameraIndex=parseInt(t.key),camera=cameras[currentCameraIndex],viewMatrix=getViewMatrix(camera)),["-","_"].includes(t.key)&&(currentCameraIndex=(currentCameraIndex+cameras.length-1)%cameras.length,viewMatrix=getViewMatrix(cameras[currentCameraIndex])),["+","="].includes(t.key)&&(currentCameraIndex=(currentCameraIndex+1)%cameras.length,viewMatrix=getViewMatrix(cameras[currentCameraIndex])),m.innerText="cam  "+currentCameraIndex,"KeyV"==t.code?(location.hash="#"+JSON.stringify(viewMatrix.map((e=>Math.round(100*e)/100))),m.innerText=""):"KeyP"===t.code&&(e=!0,m.innerText="")})),window.addEventListener("keyup",(e=>{P=P.filter((t=>t!==e.code))})),window.addEventListener("blur",(()=>{P=[]})),window.addEventListener("wheel",(t=>{e=!1,t.preventDefault();const a=10,n=1==t.deltaMode?a:2==t.deltaMode?innerHeight:1;let r=invert4(viewMatrix);r=translate4(r,0,0,t.deltaY*n*-5/innerHeight),viewMatrix=invert4(r)}),{passive:!1}),f.addEventListener("mousedown",(t=>{e=!1,t.preventDefault(),C=t.clientX,D=t.clientY,F=t.ctrlKey||t.metaKey?2:1})),f.addEventListener("contextmenu",(t=>{e=!1,t.preventDefault(),C=t.clientX,D=t.clientY,F=2})),f.addEventListener("mousemove",(e=>{if(e.preventDefault(),1==F)if(is_object){let t=invert4(viewMatrix),a=5*(e.clientX-C)/innerWidth,n=5*(e.clientY-D)/innerHeight;t=translate4(t,viewMatrix[12],viewMatrix[13],viewMatrix[14]),t=rotate4(t,a,0,1,0),t=rotate4(t,-n,1,0,0),t=translate4(t,-viewMatrix[12],-viewMatrix[13],-viewMatrix[14]),viewMatrix=invert4(t),C=e.clientX,D=e.clientY}else{let t=invert4(viewMatrix),a=5*(e.clientX-C)/innerWidth,n=5*(e.clientY-D)/innerHeight,r=4;t=translate4(t,0,0,r),t=rotate4(t,a,0,1,0),t=rotate4(t,-n,1,0,0),t=translate4(t,0,0,-r),viewMatrix=invert4(t),C=e.clientX,D=e.clientY}else if(2==F){let t=invert4(viewMatrix);t=translate4(t,-10*(e.clientX-C)/innerWidth,0,10*(e.clientY-D)/innerHeight),viewMatrix=invert4(t),C=e.clientX,D=e.clientY}})),f.addEventListener("mouseup",(e=>{e.preventDefault(),F=!1,C=0,D=0}));let B=0,X=0;f.addEventListener("touchstart",(t=>{t.preventDefault(),1===t.touches.length?(e=!1,C=t.touches[0].clientX,D=t.touches[0].clientY,F=1):2===t.touches.length&&(e=!1,C=t.touches[0].clientX,B=t.touches[1].clientX,D=t.touches[0].clientY,X=t.touches[1].clientY,F=1)}),{passive:!1}),f.addEventListener("touchmove",(e=>{if(e.preventDefault(),1===e.touches.length&&F){let t=invert4(viewMatrix),a=4*(e.touches[0].clientX-C)/innerWidth,n=4*(e.touches[0].clientY-D)/innerHeight,r=4;t=translate4(t,0,0,r),t=rotate4(t,a,0,1,0),t=rotate4(t,-n,1,0,0),t=translate4(t,0,0,-r),viewMatrix=invert4(t),C=e.touches[0].clientX,D=e.touches[0].clientY}else if(2===e.touches.length){const t=Math.atan2(D-X,C-B)-Math.atan2(e.touches[0].clientY-e.touches[1].clientY,e.touches[0].clientX-e.touches[1].clientX),a=Math.hypot(C-B,D-X)/Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY),n=(e.touches[0].clientX+e.touches[1].clientX-(C+B))/2,r=(e.touches[0].clientY+e.touches[1].clientY-(D+X))/2;let i=invert4(viewMatrix);i=rotate4(i,t,0,0,1),i=translate4(i,-n/innerWidth,-r/innerHeight,0),i=translate4(i,0,0,3*(1-a)),viewMatrix=invert4(i),C=e.touches[0].clientX,B=e.touches[1].clientX,D=e.touches[0].clientY,X=e.touches[1].clientY}}),{passive:!1}),f.addEventListener("touchend",(e=>{e.preventDefault(),F=!1,C=0,D=0}),{passive:!1});let Y,N,K=0,V=0,O=0,j=0,H=0;window.addEventListener("gamepadconnected",(e=>{navigator.getGamepads()[e.gamepad.index]})),window.addEventListener("gamepaddisconnected",(()=>{}));const W=t=>{let a=invert4(viewMatrix),n=P.includes("Shift")||P.includes("ShiftLeft")||P.includes("ShiftRight");P.includes("ArrowUp")&&(a=n?translate4(a,0,-.03,0):translate4(a,0,0,.1)),P.includes("ArrowDown")&&(a=n?translate4(a,0,.03,0):translate4(a,0,0,-.1)),P.includes("ArrowLeft")&&(a=translate4(a,-.03,0,0)),P.includes("ArrowRight")&&(a=translate4(a,.03,0,0)),P.includes("KeyA")&&(a=rotate4(a,-.01,0,1,0)),P.includes("KeyD")&&(a=rotate4(a,.01,0,1,0)),P.includes("KeyQ")&&(a=rotate4(a,.01,0,0,1)),P.includes("KeyE")&&(a=rotate4(a,-.01,0,0,1)),P.includes("KeyW")&&(a=rotate4(a,.005,1,0,0)),P.includes("KeyS")&&(a=rotate4(a,-.005,1,0,0));const r=navigator.getGamepads?navigator.getGamepads():[];let i=P.includes("Space");for(let t of r){if(!t)continue;const n=.1,r=.06,o=.02;Math.abs(t.axes[0])>n&&(a=translate4(a,r*t.axes[0],0,0),e=!1),Math.abs(t.axes[1])>n&&(a=translate4(a,0,0,-r*t.axes[1]),e=!1),(t.buttons[12].pressed||t.buttons[13].pressed)&&(a=translate4(a,0,-r*(t.buttons[12].pressed-t.buttons[13].pressed),0),e=!1),(t.buttons[14].pressed||t.buttons[15].pressed)&&(a=translate4(a,-r*(t.buttons[14].pressed-t.buttons[15].pressed),0,0),e=!1),Math.abs(t.axes[2])>n&&(a=rotate4(a,o*t.axes[2],0,1,0),e=!1),Math.abs(t.axes[3])>n&&(a=rotate4(a,-o*t.axes[3],1,0,0),e=!1);let s=t.buttons[6].value-t.buttons[7].value;Math.abs(s)>n&&(a=rotate4(a,o*s,0,0,1),e=!1),t.buttons[4].pressed&&!Y&&(camera=cameras[(cameras.indexOf(camera)+1)%cameras.length],a=invert4(getViewMatrix(camera)),e=!1),t.buttons[5].pressed&&!N&&(camera=cameras[(cameras.indexOf(camera)+cameras.length-1)%cameras.length],a=invert4(getViewMatrix(camera)),e=!1),Y=t.buttons[4].pressed,N=t.buttons[5].pressed,t.buttons[0].pressed&&(i=!0,e=!1),t.buttons[3].pressed&&(e=!0)}if(["KeyJ","KeyK","KeyL","KeyI"].some((e=>P.includes(e))))if(is_object)a=translate4(a,viewMatrix[12],viewMatrix[13],viewMatrix[14]),a=rotate4(a,P.includes("KeyJ")?-.05:P.includes("KeyL")?.05:0,0,1,0),a=rotate4(a,P.includes("KeyI")?.05:P.includes("KeyK")?-.05:0,1,0,0),a=translate4(a,-viewMatrix[12],-viewMatrix[13],-viewMatrix[14]);else{let e=4;a=translate4(a,0,0,e),a=rotate4(a,P.includes("KeyJ")?-.05:P.includes("KeyL")?.05:0,0,1,0),a=rotate4(a,P.includes("KeyI")?.05:P.includes("KeyK")?-.05:0,1,0,0),a=translate4(a,0,0,-e)}if(viewMatrix=invert4(a),e){let e=invert4(defaultViewMatrix);const t=Math.sin((Date.now()-H)/5e3);e=translate4(e,2.5*t,0,6*(1-Math.cos(t))),e=rotate4(e,-.6*t,0,1,0),viewMatrix=invert4(e)}K=i?Math.min(1,K+.05):Math.max(0,K-.05);let o=invert4(viewMatrix);o=translate4(o,0,-K,0),o=rotate4(o,-.1*K,1,0,0);let c=invert4(o);const d=multiply4(h,c);u.postMessage({view:d});j=.9*j+.1*(1e3/(t-O)||0);const f=100*V/(l.length/s);f<100?(document.getElementById("progress").style.width=f+"%",x.clear(x.COLOR_BUFFER_BIT),document.getElementById("spinner").style.display="",H=Date.now()+2e3):(document.getElementById("progress").style.display="none",document.getElementById("spinner").style.display="none",x.uniformMatrix4fv(E,!1,c),x.clear(x.COLOR_BUFFER_BIT),x.drawArraysInstanced(x.TRIANGLE_FAN,0,4,V)),v.innerText=Math.round(j)+" fps",isNaN(currentCameraIndex)&&(m.innerText=""),O=t,requestAnimationFrame(W)};W();const k=e=>{const t=new FileReader;/\.json$/i.test(e.name)?(t.onload=()=>{cameras=JSON.parse(t.result),viewMatrix=getViewMatrix(cameras[0]),h=getProjectionMatrix(camera.fx/d,camera.fy/d,f.width,f.height),x.uniformMatrix4fv(y,!1,h)},t.readAsText(e)):(J=!0,t.onload=()=>{l=new Uint8Array(t.result),112==l[0]&&108==l[1]&&121==l[2]&&10==l[3]?u.postMessage({ply:l.buffer}):u.postMessage({buffer:l.buffer,vertexCount:Math.floor(l.length/s)})},t.readAsArrayBuffer(e))};window.addEventListener("hashchange",(()=>{try{viewMatrix=JSON.parse(decodeURIComponent(location.hash.slice(1))),e=!1}catch(e){}}));const z=e=>{e.preventDefault(),e.stopPropagation()};document.addEventListener("dragenter",z),document.addEventListener("dragover",z),document.addEventListener("dragleave",z),document.addEventListener("drop",(e=>{e.preventDefault(),e.stopPropagation(),k(e.dataTransfer.files[0])}));let G=0,J=!1;for(;;){const{done:e,value:t}=await c.read();if(e||J)break;l.set(t,G),G+=t.length,V=Math.floor(G/s)}J||u.postMessage({ply:l.buffer,vertexCount:Math.floor(G/s)})}let cameras=[{id:0,img_name:"00001",width:1959,height:1090,worldToCam:[.7071067336835231,-.707106733683523,-392523088301468e-31,16385117771444577e-32,-.24184474787774538,-.24184474787774538,-.9396926425729167,6.441155315947938e-8,.6644630179132355,.6644630179132355,-.3420201144729133,2.7000000234438852,0,0,0,1],fy:582.3300643742253,fx:579.7940366519032},{id:1,img_name:"00002",width:1808,height:1024,fx:904.7391357421875,fy:910.966552734375,worldToCam:[.9999071955680847,.003145491238683462,-.013254744932055473,-.05207660049200058,-.0031783170998096466,.9999918937683105,-.002456201007589698,-.18505729734897614,.013246911577880383,.0024981009773910046,.9999091029167175,.7018542885780334,0,0,0,1]}];const vertexShaderSource="\n#version 300 es\nprecision highp float;\nprecision highp int;\n\nuniform highp usampler2D u_texture;\nuniform mat4 projection, view;\nuniform vec2 focal;\nuniform vec2 viewport;\n\nin vec2 position;\nin int index;\n\nout vec4 vColor;\nout vec2 vPosition;\n\nvoid main () {\n    uvec4 cen = texelFetch(u_texture, ivec2((uint(index) & 0x3ffu) << 1, uint(index) >> 10), 0);\n    vec4 cam = view * vec4(uintBitsToFloat(cen.xyz), 1);\n    vec4 pos2d = projection * cam;\n\n    float clip = 1.2 * pos2d.w;\n    if (pos2d.z < -clip || pos2d.x < -clip || pos2d.x > clip || pos2d.y < -clip || pos2d.y > clip) {\n        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);\n        return;\n    }\n\n    uvec4 cov = texelFetch(u_texture, ivec2(((uint(index) & 0x3ffu) << 1) | 1u, uint(index) >> 10), 0);\n    vec2 u1 = unpackHalf2x16(cov.x), u2 = unpackHalf2x16(cov.y), u3 = unpackHalf2x16(cov.z);\n    mat3 Vrk = mat3(u1.x, u1.y, u2.x, u1.y, u2.y, u3.x, u2.x, u3.x, u3.y);\n\n    mat3 J = mat3(\n        focal.x / cam.z, 0., -(focal.x * cam.x) / (cam.z * cam.z), \n        0., -focal.y / cam.z, (focal.y * cam.y) / (cam.z * cam.z), \n        0., 0., 0.\n    );\n\n    mat3 T = transpose(mat3(view)) * J;\n    mat3 cov2d = transpose(T) * Vrk * T;\n\n    float mid = (cov2d[0][0] + cov2d[1][1]) / 2.0;\n    float radius = length(vec2((cov2d[0][0] - cov2d[1][1]) / 2.0, cov2d[0][1]));\n    float lambda1 = mid + radius, lambda2 = mid - radius;\n\n    if(lambda2 < 0.0) return;\n    vec2 diagonalVector = normalize(vec2(cov2d[0][1], lambda1 - cov2d[0][0]));\n    vec2 majorAxis = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;\n    vec2 minorAxis = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);\n\n    vColor = clamp(pos2d.z/pos2d.w+1.0, 0.0, 1.0) * vec4((cov.w) & 0xffu, (cov.w >> 8) & 0xffu, (cov.w >> 16) & 0xffu, (cov.w >> 24) & 0xffu) / 255.0;\n    vPosition = position;\n\n    vec2 vCenter = vec2(pos2d) / pos2d.w;\n    gl_Position = vec4(\n        vCenter \n        + position.x * majorAxis / viewport \n        + position.y * minorAxis / viewport, 0.0, 1.0);\n\n}\n".trim(),fragmentShaderSource="\n#version 300 es\nprecision highp float;\n\nin vec4 vColor;\nin vec2 vPosition;\n\nout vec4 fragColor;\n\nvoid main () {\n    float A = -dot(vPosition, vPosition);\n    if (A < -4.0) discard;\n    float B = exp(A) * vColor.a;\n    fragColor = vec4(B * vColor.rgb, B);\n}\n\n".trim(),params=new URLSearchParams(location.search);let temp=params.get("is_object")||"true",defaultViewMatrix=getViewMatrix(cameras[0]),viewMatrix=defaultViewMatrix,currentCameraIndex=0;main().catch((e=>{document.getElementById("spinner").style.display="none",document.getElementById("message").innerText=e.toString()}));